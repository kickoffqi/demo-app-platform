name: CD - Deploy to AKS

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Target env"
                required: true
                type: choice
                options: [dev, staging, prod]
            image_tag:
                description: "Image tag (usually git sha)"
                required: true
                type: string

permissions:
    contents: read
    id-token: write

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

            - name: Install kubectl
              uses: azure/setup-kubectl@v4

            - name: Get AKS credentials
              run: |
                  az aks get-credentials -g "${{ vars.AKS_RG }}" -n "${{ vars.AKS_NAME }}" --overwrite-existing

            - name: Set image tag in kustomize overlay
              run: |
                  FILE="k8s/overlays/${{ inputs.environment }}/kustomization.yaml"
                  python - << 'PY'
                  import os, re
                  path=os.environ["FILE"]
                  tag=os.environ["TAG"]
                  with open(path,"r",encoding="utf-8") as f: s=f.read()
                  s=re.sub(r'(?m)^\s*newTag:\s*.*$', f'    newTag: {tag}', s)
                  with open(path,"w",encoding="utf-8") as f: f.write(s)
                  print("Updated", path, "to", tag)
                  PY
              env:
                  FILE: k8s/overlays/${{ inputs.environment }}/kustomization.yaml
                  TAG: ${{ inputs.image_tag }}

            - name: Diff
              run: |
                  kubectl diff -k "k8s/overlays/${{ inputs.environment }}" || true

            - name: Apply
              run: |
                  kubectl apply -k "k8s/overlays/${{ inputs.environment }}"
                  kubectl rollout status deploy/demo-app -n default --timeout=300s

            - name: Show service
              run: |
                  kubectl get svc demo-app -n default -o wide
