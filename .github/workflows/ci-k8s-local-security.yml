name: CI - Local K8s smoke + Security scans

on:
    pull_request:
        branches: ["main"]
    push:
        branches: ["main"]

permissions:
    contents: read

jobs:
    ci:
        runs-on: ubuntu-latest
        timeout-minutes: 18

        env:
            APP_NAME: demo-app
            NAMESPACE: default
            PORT: "8080"
            IMAGE_LOCAL: demo-app:local
            KIND_CLUSTER: dev

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Summary (header)
              run: |
                  {
                      echo "# CI Report"
                      echo ""
                      echo "**Repo:** $GITHUB_REPOSITORY"
                      echo "**Ref:** $GITHUB_REF"
                      echo "**SHA:** \`$GITHUB_SHA\`"
                      echo "**Actor:** $GITHUB_ACTOR"
                      echo ""
                      echo "## Build & Deploy Targets"
                      echo "- **APP:** \`${APP_NAME}\`"
                      echo "- **Namespace:** \`${NAMESPACE}\`"
                      echo "- **Local Image:** \`${IMAGE_LOCAL}\`"
                      echo "- **Overlay:** \`k8s/overlays/local\`"
                      echo "- **Kind Cluster:** \`${KIND_CLUSTER}\`"
                      echo ""
                      echo "## Stage Results"
                      echo "- ⏳ Dependency scan (pip-audit)"
                      echo "- ⏳ Trivy repo scan (secrets/misconfig)"
                      echo "- ⏳ Trivy image scan (CVE)"
                      echo "- ⏳ kind deploy + smoke test"
                  } >> "$GITHUB_STEP_SUMMARY"

            # -------- Security: Dependency scan (pip-audit) --------
            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: pip-audit (Python deps)
              run: |
                  set -e
                  python -m pip install --upgrade pip
                  pip install pip-audit
                  # 如果你的 requirements 在 app/requirements.txt
                  pip-audit -r app/requirements.txt -f json -o pip-audit.json || true
                  echo "pip-audit finished (non-blocking)."

            # -------- Build image (local) --------
            - name: Build local image
              run: |
                  set -e
                  docker build -t "${IMAGE_LOCAL}" -f app/Dockerfile app
                  docker image ls | head

            # -------- Security: Trivy filesystem scan (IaC/Secrets/Misconfig) --------
            - name: Trivy filesystem scan (repo) - block on CRITICAL
              uses: aquasecurity/trivy-action@0.20.0
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "table"
                  exit-code: "1" # ✅ 阻断
                  scanners: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL" # ✅ 重点扫 secret + misconfig
                  severity: "CRITICAL"

            - name: Summary (Trivy repo scan)
              if: always()
              run: |
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "### ✅ Trivy repo scan (secrets/misconfig)" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Result: see logs above (blocked on secrets/misconfig if found)" >> "$GITHUB_STEP_SUMMARY"

            # -------- Security: Trivy image scan (vulns) --------
            - name: Trivy image scan
              uses: aquasecurity/trivy-action@0.20.0
              with:
                  image-ref: "${{ env.IMAGE_LOCAL }}"
                  format: "table"
                  exit-code: "1" # 先不阻断；后面你想“挡 CRITICAL”再改成 1
                  severity: "CRITICAL"
                  ignore-unfixed: "true"

            - name: Summary (Trivy image scan)
              if: always()
              run: |
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "### ✅ Trivy image scan (CVE)" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Policy: **block on CRITICAL**" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Image: \`${IMAGE_LOCAL}\`" >> "$GITHUB_STEP_SUMMARY"

            # -------- K8s: kind cluster --------
            - name: Install kubectl
              uses: azure/setup-kubectl@v4

            - name: Install kind
              run: |
                  set -e
                  KIND_VERSION="v0.27.0"
                  curl -Lo kind "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64"
                  chmod +x kind
                  sudo mv kind /usr/local/bin/kind
                  kind version

            - name: Create kind cluster
              run: |
                  set -e
                  kind create cluster --name "${KIND_CLUSTER}"
                  kubectl cluster-info
                  kubectl get nodes -o wide

            - name: Load image into kind
              run: |
                  set -e
                  kind load docker-image "${IMAGE_LOCAL}" --name "${KIND_CLUSTER}"

            - name: Deploy (kustomize local overlay)
              run: |
                  set -e
                  kubectl apply -k k8s/overlays/local
                  kubectl rollout status deploy/${APP_NAME} -n ${NAMESPACE} --timeout=180s
                  kubectl get pods -n ${NAMESPACE} -o wide

            - name: Smoke test (scripts/smoke-test.sh)
              run: |
                  set -e
                  APP_NAME=${APP_NAME} NAMESPACE=${NAMESPACE} PORT=${PORT} ./scripts/smoke-test.sh

            - name: Summary (K8s smoke)
              if: success()
              run: |
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "### ✅ kind deploy + smoke test" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Deployment: \`${APP_NAME}\` in \`${NAMESPACE}\`" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Smoke: passed" >> "$GITHUB_STEP_SUMMARY"

            - name: Debug dump on failure
              if: failure()
              run: |
                  APP_NAME=${APP_NAME} NAMESPACE=${NAMESPACE} ./scripts/k8s-debug-dump.sh || true

            - name: Upload reports (artifact)
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: ci-reports
                  path: |
                      pip-audit.json

            - name: Cleanup
              if: always()
              run: |
                  kind delete cluster --name "${KIND_CLUSTER}" || true

            - name: Summary (pip-audit)
              if: always()
              run: |
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "### ✅ Dependency scan (pip-audit)" >> "$GITHUB_STEP_SUMMARY"
                  if [ -f pip-audit.json ]; then
                      COUNT=$(python - << 'PY'
                      import json
                      p="pip-audit.json"
                      try:
                      data=json.load(open(p,"r",encoding="utf-8"))
                      # pip-audit json: vulnerabilities list
                      vulns=data.get("vulnerabilities", [])
                      print(len(vulns))
                      except Exception:
                      print("unknown")
                      PY
                      )
                      echo "- Findings: **$COUNT** (see artifact: ci-reports/pip-audit.json)" >> "$GITHUB_STEP_SUMMARY"
                  else
                      echo "- No report file generated." >> "$GITHUB_STEP_SUMMARY"
                  fi

            - name: Summary (Failure guide)
              if: failure()
              run: |
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "## ❌ Failure guide" >> "$GITHUB_STEP_SUMMARY"
                  echo "1) Check **Trivy** step output (secrets/misconfig or CRITICAL CVE)." >> "$GITHUB_STEP_SUMMARY"
                  echo "2) Check **Deploy** and **Smoke test** steps." >> "$GITHUB_STEP_SUMMARY"
                  echo "3) See **Debug dump on failure** (pods/events/describe/logs)." >> "$GITHUB_STEP_SUMMARY"
