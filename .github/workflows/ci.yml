name: CI - Build & Push

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read
    id-token: write

jobs:
    build_push:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

            - name: ACR login
              run: |
                  ACR_NAME="${ACR_LOGIN_SERVER%%.azurecr.io}"
                  az acr login --name "$ACR_NAME"
                  echo "IMAGE=${ACR_LOGIN_SERVER}/demo-app:${GITHUB_SHA}" >> $GITHUB_ENV
              env:
                  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}
                  GITHUB_SHA: ${{ github.sha }}

            - name: Build & Push
              run: |
                  docker build -t "$IMAGE" ./app
                  docker push "$IMAGE"

            - name: Print image tag
              run: echo "Pushed $IMAGE"
