name: CI - Build & Push

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read
    id-token: write

jobs:
    build_push:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

            - name: ACR login
              run: |
                  az acr login --name "${{ vars.ACR_LOGIN_SERVER%%.azurecr.io }}"
                  echo "IMAGE=${{ vars.ACR_LOGIN_SERVER }}/demo-app:${{ github.sha }}" >> $GITHUB_ENV

            - name: Build & Push
              run: |
                  docker build -t "$IMAGE" ./app
                  docker push "$IMAGE"

            - name: Print image tag
              run: echo "Pushed $IMAGE"
