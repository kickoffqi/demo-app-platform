name: CI - Build SHA Image & Promote Tags

on:
    push:
        branches: [main]
        tags:
            - "v*.*.*"
            - "v*.*.*-rc.*"
            - "v*.*.*-beta.*"
    pull_request:
        branches: [main]

permissions:
    contents: read
    id-token: write

env:
    APP_NAME: demo-app

jobs:
    build_or_promote:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                  client-id: ${{ vars.AZURE_CLIENT_ID }}
                  tenant-id: ${{ vars.AZURE_TENANT_ID }}
                  subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

            - name: ACR login
              run: |
                  ACR_NAME="${ACR_LOGIN_SERVER%%.azurecr.io}"
                  az acr login --name "$ACR_NAME"

                  echo "IMAGE_SHA=${ACR_LOGIN_SERVER}/${APP_NAME}:${GITHUB_SHA}" >> $GITHUB_ENV
                  echo "ACR_NAME=$ACR_NAME" >> $GITHUB_ENV
              env:
                  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}

            # PR 只验证，不 push
            - name: PR - Build only (no push)
              if: github.event_name == 'pull_request'
              run: |
                  docker build -t "${IMAGE_SHA}" ./app

            # main 分支：build & push SHA（永远存在）
            - name: main - Build & push SHA image
              if: github.ref_type == 'branch' && github.ref_name == 'main'
              run: |
                  docker build -t "${IMAGE_SHA}" ./app
                  docker push "${IMAGE_SHA}"

            # tag：不 rebuild，直接从 ACR 拉 SHA 镜像 → retag 为 SemVer → push
            - name: tag - Promote SHA image to SemVer tag (no rebuild)
              if: github.ref_type == 'tag'
              run: |
                  SEMVER="${GITHUB_REF_NAME}"
                  IMAGE_SEMVER="${{ vars.ACR_LOGIN_SERVER }}/${APP_NAME}:${SEMVER}"

                  echo "Promoting ${IMAGE_SHA} -> ${IMAGE_SEMVER}"

                  # 先确认 SHA 镜像存在（更友好）
                  if ! az acr repository show-tags -n "${ACR_NAME}" --repository "${APP_NAME}" --query "[?@=='${GITHUB_SHA}'] | length(@)" -o tsv | grep -q '^1$'; then
                    echo "SHA image not found in ACR. Fallback: build & push SHA first."
                    docker build -t "${IMAGE_SHA}" ./app
                    docker push "${IMAGE_SHA}"
                  fi

                  docker pull "${IMAGE_SHA}"
                  docker tag  "${IMAGE_SHA}" "${IMAGE_SEMVER}"
                  docker push "${IMAGE_SEMVER}"

                  echo "IMAGE_SEMVER=${IMAGE_SEMVER}" >> $GITHUB_ENV

            - name: Summary
              run: |
                  echo "Pushed SHA: ${IMAGE_SHA}"
                  if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
                    echo "Promoted tag: ${IMAGE_SEMVER}"
                  fi
